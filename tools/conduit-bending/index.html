<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conduit Bending Calculator - Free Offset, Saddle, 90 | Sparky HQ</title>
    <meta name="description" content="Free conduit bending calculator for electricians. Calculate offsets, saddles, kicks, and 90s with multipliers and shrink values for EMT, IMC, and RMC.">
    <link rel="icon" type="image/png" href="/assets/logo.png">
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#1c1c1c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="stylesheet" href="/css/style.css?v=12">
    <script src="/js/validate.js" defer></script>
    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
        }
    }
    </script>
    <script type="module">
    import * as THREE from 'three';
    import { TrackballControls } from 'three/addons/controls/TrackballControls.js';
    window.THREE = THREE;
    window.TrackballControls = TrackballControls;
    </script>
</head>
<body>
    <header class="site-header">
        <div class="container">
            <a href="/" class="logo"><img src="/assets/logo.png" alt="Sparky HQ" height="50"></a>
            <nav>
                <a href="/tools/">Tools</a>
                <a href="/tables/">Tables</a>
                <a href="/about.html">About</a>
            </nav>
        </div>
    </header>

    <main>
        <section class="calc-page">
            <div class="container">
                <h1>Conduit Bending Calculator <span class="nec-ref">Offsets &bull; Saddles &bull; 90s</span></h1>
                <p class="subtitle">Calculate multipliers, shrink, and mark distances for common conduit bends.</p>

                <div class="calc-form">
                    <div class="method-toggle" id="mode-toggle" style="flex-wrap:wrap;overflow:visible;">
                        <button class="active" onclick="setMode('offset')">Offset</button>
                        <button onclick="setMode('3saddle')">3-Pt Saddle</button>
                        <button onclick="setMode('4saddle')">4-Pt Saddle</button>
                        <button onclick="setMode('stub')">90&deg;</button>
                        <button onclick="setMode('planner')">Plan a Stick</button>
                    </div>

                    <!-- Offset & Saddle Inputs -->
                    <div id="inputs-bend">
                        <div class="form-group">
                            <label for="obstruction" id="obstruction-label">Obstruction Height (inches)</label>
                            <input type="number" id="obstruction" placeholder="e.g. 4" min="0.1" step="any">
                            <p class="field-note" id="obstruction-note">How far the conduit needs to move to clear the obstruction.</p>
                        </div>

                        <div class="form-group">
                            <label for="bend-angle">Bend Angle</label>
                            <select id="bend-angle">
                                <option value="10">10&deg;</option>
                                <option value="22.5">22.5&deg;</option>
                                <option value="30" selected>30&deg;</option>
                                <option value="45">45&deg;</option>
                                <option value="60">60&deg;</option>
                            </select>
                        </div>
                    </div>

                    <!-- 90 Stub Inputs -->
                    <div id="inputs-stub" style="display:none;">
                        <div class="form-group">
                            <label for="stub-length">Stub-Up Length (inches)</label>
                            <input type="number" id="stub-length" placeholder="e.g. 12" min="1" step="any">
                            <p class="field-note">Measured from the floor or surface to the top of the stub.</p>
                        </div>

                        <div class="form-group">
                            <label for="conduit-size">Conduit Size (EMT)</label>
                            <select id="conduit-size">
                                <option value="0.5">1/2"</option>
                                <option value="0.75">3/4"</option>
                                <option value="1">1"</option>
                                <option value="1.25">1-1/4"</option>
                                <option value="1.5">1-1/2"</option>
                                <option value="2">2"</option>
                            </select>
                        </div>
                    </div>

                    <!-- Plan a Stick Inputs -->
                    <div id="inputs-planner" style="display:none;">
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                            <div class="form-group">
                                <label for="stick-length">Stick Length (inches)</label>
                                <input type="number" id="stick-length" value="120" min="1" max="120" step="1">
                                <p class="field-note">Standard 10ft stick = 120" (max)</p>
                            </div>
                            <div class="form-group">
                                <label for="planner-conduit-size">Conduit Size (EMT)</label>
                                <select id="planner-conduit-size">
                                    <option value="0.5">1/2"</option>
                                    <option value="0.75">3/4"</option>
                                    <option value="1">1"</option>
                                </select>
                            </div>
                        </div>

                        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px;">
                            <button class="btn btn-outline" onclick="showAddBendForm('stub90')" style="font-size:0.85rem;">+ 90&deg;</button>
                            <button class="btn btn-outline" onclick="showAddBendForm('offset')" style="font-size:0.85rem;">+ Offset</button>
                            <button class="btn btn-outline" onclick="showAddBendForm('saddle3')" style="font-size:0.85rem;">+ Saddle</button>
                            <button class="btn btn-outline" onclick="showAddBendForm('kick')" style="font-size:0.85rem;">+ Kick</button>
                        </div>

                        <div id="planner-bend-form" style="display:none;background:var(--gray);border-radius:var(--radius);padding:12px 16px;margin-bottom:12px;"></div>

                        <div id="planner-bend-list"></div>

                        <div id="planner-warnings"></div>

                        <div id="viewer-3d-wrap" style="background:#ffffff;border:1px solid var(--border);border-radius:var(--radius);margin:12px 0;height:400px;position:relative;display:none;">
                            <canvas id="viewer-3d" style="width:100%;height:100%;display:block;"></canvas>
                            <button onclick="reset3DCamera()" style="position:absolute;top:8px;right:8px;background:var(--gray);color:var(--text-light);border:1px solid var(--border);padding:4px 10px;border-radius:4px;font-size:0.78rem;cursor:pointer;">Reset View</button>
                            <div id="viewer-3d-fallback" style="display:none;position:absolute;inset:0;align-items:center;justify-content:center;color:#666;font-size:0.85rem;text-align:center;padding:20px;">3D viewer unavailable.<br>Bend marks are shown above.</div>
                        </div>
                    </div>

                    <div class="apply-section">
                        <p class="apply-terms">By clicking Apply, you acknowledge that results are for reference only and must be verified by a qualified electrician.</p>
                        <div style="display:flex;gap:10px;flex-wrap:wrap;">
                            <button class="btn" onclick="applyCalc()">Apply</button>
                            <button class="btn btn-outline" onclick="clearAll()">Clear</button>
                        </div>
                    </div>
                </div>

                <div id="validation-messages"></div>
                <div class="result" id="result"></div>

                <div class="info-box" style="margin-top:24px;" id="info-offset">
                    <strong>How It Works</strong><br>
                    Multiplier &times; obstruction height = distance between bends. Shrink tells you how much shorter your conduit run becomes after bending.
                </div>

                <div class="info-box" style="margin-top:24px;display:none;" id="info-stub">
                    <strong>Deduct (Take-Up)</strong><br>
                    For a 90&deg; stub, subtract the deduct from your stub-up length to find where to place your mark. The deduct varies by conduit size and bender manufacturer.
                </div>

                <div class="info-box" style="margin-top:24px;display:none;" id="info-planner">
                    <strong>How It Works</strong><br>
                    Add bends in order from the cut end of the stick. Position = distance from the cut end where the first mark goes. The tool calculates all marks, checks bender shoe clearance, and shows total shrink.
                    <br><br>
                    <a href="/tables/conduit-bending/" style="color:var(--accent);font-weight:600;text-decoration:none;">View Bending Reference Tables &rarr;</a>
                </div>

                <div class="caution-box">
                    <strong>Verify With Your Bender</strong><br>
                    Deduct values are for standard EMT benders (Ideal, Klein, Greenlee). Always verify with the markings on your bender's shoe — values can vary by manufacturer and conduit type.
                </div>

                <div class="tip-box">
                    <strong>Pro Tip</strong><br>
                    Mark your conduit before cutting. Shrink reduces your total run — account for it when measuring your stick.
                </div>
            </div>
        </section>
        <div class="disclaimer-box">
            <p>For reference only. Verify all results with the current NEC and local amendments. See <a href="/terms.html">Terms of Use</a>.</p>
        </div>
    </main>

    <footer class="site-footer">
        <div class="container">
            <p>&copy; 2026 Sparky HQ.</p>
            <p>Tools are for reference only. Always verify with the current NEC and local amendments. <a href="/terms.html" style="color:#aaa;text-decoration:underline;">Terms of Use</a></p>
        </div>
    </footer>

    <script>
    // ══════════════════════════════════════
    //  CONDUIT BENDING CALCULATOR
    // ══════════════════════════════════════

    // Multiplier table: angle → multiplier
    var MULTIPLIERS = {
        '10': 6.0,
        '22.5': 2.613,
        '30': 2.0,
        '45': 1.414,
        '60': 1.155
    };

    // Shrink per inch of offset: angle → inches of shrink per inch of obstruction
    var SHRINK_PER_INCH = {
        '10': 0.0625,    // 1/16"
        '22.5': 0.1875,  // 3/16"
        '30': 0.25,      // 1/4"
        '45': 0.375,     // 3/8"
        '60': 0.5        // 1/2"
    };

    // Shrink display labels
    var SHRINK_LABELS = {
        '10': '1/16"',
        '22.5': '3/16"',
        '30': '1/4"',
        '45': '3/8"',
        '60': '1/2"'
    };

    // 90° stub deduct by conduit size (inches) — standard EMT benders
    var DEDUCT = {
        '0.5': 5,
        '0.75': 6,
        '1': 8,
        '1.25': 11,
        '1.5': 13,
        '2': 15
    };

    var CONDUIT_LABELS = {
        '0.5': '1/2"',
        '0.75': '3/4"',
        '1': '1"',
        '1.25': '1-1/4"',
        '1.5': '1-1/2"',
        '2': '2"'
    };

    // Bender shoe length by conduit size (inches) — for feasibility checking
    var BENDER_SHOE = { '0.5':6, '0.75':6, '1':8, '1.25':11, '1.5':11, '2':14 };

    // Centerline bend radius by conduit size (inches) — EMT standard
    var BEND_RADIUS = { '0.5':4, '0.75':4.5, '1':5.75, '1.25':7.25, '1.5':8.25, '2':9.5 };

    var currentMode = 'offset';

    function setMode(mode) {
        currentMode = mode;
        var btns = document.querySelectorAll('#mode-toggle button');
        var labels = { 'offset': 'Offset', '3saddle': '3-Pt Saddle', '4saddle': '4-Pt Saddle', 'stub': '90\u00B0', 'planner': 'Plan a Stick' };
        for (var i = 0; i < btns.length; i++) {
            btns[i].classList.remove('active');
            if (btns[i].textContent.indexOf(labels[mode]) !== -1 || btns[i].textContent === labels[mode]) {
                btns[i].classList.add('active');
            }
        }

        // Show/hide inputs
        var bendInputs = document.getElementById('inputs-bend');
        var stubInputs = document.getElementById('inputs-stub');
        var plannerInputs = document.getElementById('inputs-planner');
        var infoOffset = document.getElementById('info-offset');
        var infoStub = document.getElementById('info-stub');
        var infoPlanner = document.getElementById('info-planner');

        bendInputs.style.display = 'none';
        stubInputs.style.display = 'none';
        plannerInputs.style.display = 'none';
        infoOffset.style.display = 'none';
        infoStub.style.display = 'none';
        infoPlanner.style.display = 'none';

        if (mode === 'stub') {
            stubInputs.style.display = '';
            infoStub.style.display = '';
        } else if (mode === 'planner') {
            plannerInputs.style.display = '';
            infoPlanner.style.display = '';
            initPlanner();
        } else {
            bendInputs.style.display = '';
            infoOffset.style.display = '';
        }

        // Update labels based on mode
        var obLabel = document.getElementById('obstruction-label');
        var obNote = document.getElementById('obstruction-note');
        var angleSelect = document.getElementById('bend-angle');

        if (mode === 'offset') {
            obLabel.textContent = 'Offset Height (inches)';
            obNote.textContent = 'How far the conduit needs to offset to clear the obstruction.';
        } else if (mode === '3saddle') {
            obLabel.textContent = 'Obstruction Height (inches)';
            obNote.textContent = 'Height of the obstruction the conduit must saddle over.';
        } else if (mode === '4saddle') {
            obLabel.textContent = 'Obstruction Height (inches)';
            obNote.textContent = 'Height of the obstruction. Uses 22.5\u00B0 and 45\u00B0 bends.';
        }

        // Show/hide angle selector for 4-point saddle
        var angleGroup = angleSelect.closest('.form-group');
        if (mode === '4saddle') {
            angleGroup.style.display = 'none';
        } else {
            angleGroup.style.display = '';
        }

        clearAll();
    }

    function fmt(n) {
        if (n === 0) return '0';
        if (Math.abs(n) >= 100) return n.toFixed(1);
        if (Math.abs(n) >= 1) return n.toFixed(2);
        return n.toFixed(3);
    }

    function toFraction(decimal) {
        var sixteenths = Math.round(decimal * 16);
        var whole = Math.floor(sixteenths / 16);
        var remainder = sixteenths % 16;

        if (remainder === 0) return whole + '"';

        var num = remainder;
        var den = 16;
        while (num % 2 === 0) { num /= 2; den /= 2; }

        if (whole > 0) return whole + '-' + num + '/' + den + '"';
        return num + '/' + den + '"';
    }

    function clearAll() {
        document.getElementById('obstruction').value = '';
        document.getElementById('stub-length').value = '';
        SparkyValidate.clearMessages('validation-messages');
        var resultEl = document.getElementById('result');
        resultEl.classList.remove('show');
        resultEl.innerHTML = '';
        if (currentMode === 'planner') {
            clearPlanner();
        }
    }

    function applyCalc() {
        var rules = [];

        if (currentMode === 'planner') {
            if (plannerState.bends.length === 0) {
                rules.push({ rule: 'custom', test: true, level: 'error', msg: 'Add at least one bend to calculate marks.' });
            }
            var result = SparkyValidate.check(rules);
            SparkyValidate.showMessages('validation-messages', result);
            if (!result.valid) return;
            SparkyValidate.logApply();
            calcPlanner();
            return;
        }

        if (currentMode === 'stub') {
            var stubLen = parseFloat(document.getElementById('stub-length').value);
            if (isNaN(stubLen) || stubLen <= 0) {
                rules.push({ rule: 'custom', test: true, level: 'error', msg: 'Enter a stub-up length greater than 0.' });
            }
        } else {
            var obsHeight = parseFloat(document.getElementById('obstruction').value);
            if (isNaN(obsHeight) || obsHeight <= 0) {
                rules.push({ rule: 'custom', test: true, level: 'error', msg: 'Enter an obstruction height greater than 0.' });
            }
        }

        var result = SparkyValidate.check(rules);
        SparkyValidate.showMessages('validation-messages', result);
        if (!result.valid) return;

        SparkyValidate.logApply();

        if (currentMode === 'stub') {
            calcStub();
        } else if (currentMode === '4saddle') {
            calc4Saddle();
        } else if (currentMode === '3saddle') {
            calc3Saddle();
        } else {
            calcOffset();
        }
    }

    function calcOffset() {
        var height = parseFloat(document.getElementById('obstruction').value);
        var angle = document.getElementById('bend-angle').value;
        var mult = MULTIPLIERS[angle];
        var shrinkRate = SHRINK_PER_INCH[angle];
        var shrinkLabel = SHRINK_LABELS[angle];

        var distance = height * mult;
        var shrink = height * shrinkRate;

        var html = '';
        html += '<div style="font-weight:700;font-size:1.1rem;margin-bottom:14px;padding:10px 16px;background:#f5f0e6;border-left:4px solid var(--accent);border-radius:0 6px 6px 0;color:var(--text);">Offset Results</div>';
        html += '<table class="breakdown-table">';
        html += '<tr><td>Bend Angle</td><td>' + angle + '\u00B0</td></tr>';
        html += '<tr><td>Offset Height</td><td>' + fmt(height) + '" (' + toFraction(height) + ')</td></tr>';
        html += '<tr><td>Multiplier</td><td>' + mult + '</td></tr>';
        html += '<tr><td>Distance Between Bends</td><td style="font-weight:700;font-size:1.1rem;">' + fmt(distance) + '" (' + toFraction(distance) + ')</td></tr>';
        html += '<tr><td>Shrink per inch</td><td>' + shrinkLabel + '</td></tr>';
        html += '<tr><td>Total Shrink</td><td style="font-weight:700;">' + fmt(shrink) + '" (' + toFraction(shrink) + ')</td></tr>';
        html += '</table>';

        html += '<div style="margin-top:16px;padding:12px 16px;background:var(--gray);border-radius:6px;font-size:0.88rem;">';
        html += '<strong>How to bend:</strong> Make your first bend at the start mark. Measure ' + fmt(distance) + '" from the first bend mark and make your second bend at the same angle.';
        html += '</div>';

        showResult(html);
    }

    function calc3Saddle() {
        var height = parseFloat(document.getElementById('obstruction').value);
        var angle = document.getElementById('bend-angle').value;
        var mult = MULTIPLIERS[angle];
        var shrinkRate = SHRINK_PER_INCH[angle];
        var shrinkLabel = SHRINK_LABELS[angle];

        var centerAngle = parseFloat(angle);
        var outerAngle = centerAngle / 2;

        var distance = height * mult;
        var shrink = height * shrinkRate;

        var html = '';
        html += '<div style="font-weight:700;font-size:1.1rem;margin-bottom:14px;padding:10px 16px;background:#f5f0e6;border-left:4px solid var(--accent);border-radius:0 6px 6px 0;color:var(--text);">3-Point Saddle Results</div>';
        html += '<table class="breakdown-table">';
        html += '<tr><td>Center Bend Angle</td><td>' + angle + '\u00B0</td></tr>';
        html += '<tr><td>Outer Bend Angles</td><td>' + outerAngle + '\u00B0 each</td></tr>';
        html += '<tr><td>Obstruction Height</td><td>' + fmt(height) + '"</td></tr>';
        html += '<tr><td>Multiplier</td><td>' + mult + '</td></tr>';
        html += '<tr><td>Distance: Center to Outer Bends</td><td style="font-weight:700;font-size:1.1rem;">' + fmt(distance) + '" (' + toFraction(distance) + ')</td></tr>';
        html += '<tr><td>Total Shrink</td><td style="font-weight:700;">' + fmt(shrink) + '" (' + toFraction(shrink) + ')</td></tr>';
        html += '</table>';

        html += '<div style="margin-top:16px;padding:12px 16px;background:var(--gray);border-radius:6px;font-size:0.88rem;">';
        html += '<strong>How to bend:</strong> Mark the center of the obstruction on your conduit. Measure ' + fmt(distance) + '" in each direction for the outer bend marks. Bend the center at ' + angle + '\u00B0, then each outer mark at ' + outerAngle + '\u00B0 in the opposite direction.';
        html += '</div>';

        showResult(html);
    }

    function calc4Saddle() {
        var height = parseFloat(document.getElementById('obstruction').value);

        var angle = 22.5;
        var mult = MULTIPLIERS['22.5'];
        var shrinkRate = SHRINK_PER_INCH['22.5'];

        var distance = height * mult;
        var shrink = height * shrinkRate * 2;
        var centerSpacing = distance;
        var outerSpacing = distance;

        var html = '';
        html += '<div style="font-weight:700;font-size:1.1rem;margin-bottom:14px;padding:10px 16px;background:#f5f0e6;border-left:4px solid var(--accent);border-radius:0 6px 6px 0;color:var(--text);">4-Point Saddle Results</div>';
        html += '<table class="breakdown-table">';
        html += '<tr><td>Bend Angles</td><td>22.5\u00B0 (all four bends)</td></tr>';
        html += '<tr><td>Obstruction Height</td><td>' + fmt(height) + '"</td></tr>';
        html += '<tr><td>Multiplier (22.5\u00B0)</td><td>' + mult + '</td></tr>';
        html += '<tr><td>Distance Between Bends</td><td style="font-weight:700;font-size:1.1rem;">' + fmt(distance) + '" (' + toFraction(distance) + ')</td></tr>';
        html += '<tr><td>Total Shrink</td><td style="font-weight:700;">' + fmt(shrink) + '" (' + toFraction(shrink) + ')</td></tr>';
        html += '</table>';

        html += '<div style="margin-top:16px;padding:12px 16px;background:var(--gray);border-radius:6px;font-size:0.88rem;">';
        html += '<strong>How to bend:</strong> Mark the center of the obstruction. Place marks at ' + fmt(distance) + '" on each side of center (4 marks total, evenly spaced ' + fmt(distance) + '" apart). All four bends are 22.5\u00B0 \u2014 outer bends go one direction, inner bends go the opposite.';
        html += '</div>';

        showResult(html);
    }

    function calcStub() {
        var stubLen = parseFloat(document.getElementById('stub-length').value);
        var size = document.getElementById('conduit-size').value;
        var deduct = DEDUCT[size];
        var sizeLabel = CONDUIT_LABELS[size];

        var mark = stubLen - deduct;

        var html = '';
        html += '<div style="font-weight:700;font-size:1.1rem;margin-bottom:14px;padding:10px 16px;background:#f5f0e6;border-left:4px solid var(--accent);border-radius:0 6px 6px 0;color:var(--text);">90\u00B0 Results</div>';
        html += '<table class="breakdown-table">';
        html += '<tr><td>Conduit Size</td><td>' + sizeLabel + ' EMT</td></tr>';
        html += '<tr><td>Desired Stub Length</td><td>' + fmt(stubLen) + '"</td></tr>';
        html += '<tr><td>Deduct (Take-Up)</td><td>' + deduct + '"</td></tr>';
        html += '<tr><td>Mark From End</td><td style="font-weight:700;font-size:1.1rem;">' + fmt(mark) + '" (' + toFraction(mark) + ')</td></tr>';
        html += '</table>';

        if (mark <= 0) {
            html += '<div class="warning-box" style="margin-top:12px;"><strong>Warning</strong><br>The stub length is less than or equal to the deduct. Your mark would be at or past the end of the conduit. Increase the stub length.</div>';
        }

        html += '<div style="margin-top:16px;padding:12px 16px;background:var(--gray);border-radius:6px;font-size:0.88rem;">';
        html += '<strong>How to bend:</strong> Measure ' + fmt(mark) + '" from the end of the conduit and make your mark. Line up the mark with the arrow on the bender shoe. Step on the bender and pull a 90\u00B0 bend.';
        html += '</div>';

        html += '<div style="margin-top:20px;padding-top:16px;border-top:1px solid var(--border);">';
        html += '<details><summary style="font-weight:700;font-size:0.92rem;color:var(--accent);padding:10px 16px;user-select:none;background:var(--gray);border-left:4px solid var(--accent);border-radius:0 6px 6px 0;cursor:pointer;">Deduct Reference (All Sizes)</summary>';
        html += '<div style="margin-top:12px;">';
        html += '<table class="breakdown-table">';
        html += '<tr><th>Conduit Size</th><th>Deduct</th></tr>';
        html += '<tr><td>1/2" EMT</td><td>5"</td></tr>';
        html += '<tr><td>3/4" EMT</td><td>6"</td></tr>';
        html += '<tr><td>1" EMT</td><td>8"</td></tr>';
        html += '<tr><td>1-1/4" EMT</td><td>11"</td></tr>';
        html += '<tr><td>1-1/2" EMT</td><td>13"</td></tr>';
        html += '<tr><td>2" EMT</td><td>15"</td></tr>';
        html += '</table>';
        html += '</div></details>';
        html += '</div>';

        showResult(html);
    }

    function showResult(html) {
        var resultEl = document.getElementById('result');
        resultEl.innerHTML = html;
        resultEl.classList.add('show');
    }

    // ══════════════════════════════════════
    //  PLAN A STICK — Form-Based Planner
    // ══════════════════════════════════════

    var plannerState = {
        stickLength: 120,
        conduitSize: '0.5',
        bends: [],
        nextId: 1
    };

    var plannerInited = false;
    var editingBendId = null; // null = adding new, number = editing existing

    function initPlanner() {
        if (plannerInited) return;
        plannerInited = true;
        // Listen for stick length and conduit size changes
        document.getElementById('stick-length').addEventListener('change', function() {
            var val = parseFloat(this.value) || 120;
            if (val > 120) { val = 120; this.value = 120; }
            plannerState.stickLength = val;
            if (plannerState.bends.length > 0) recalcAllBends();
        });
        document.getElementById('planner-conduit-size').addEventListener('change', function() {
            plannerState.conduitSize = this.value;
            if (plannerState.bends.length > 0) recalcAllBends();
        });
    }

    function clearPlanner() {
        plannerState.bends = [];
        plannerState.nextId = 1;
        editingBendId = null;
        hideAddBendForm();
        renderBendList();
        document.getElementById('planner-warnings').innerHTML = '';
        var viewerWrap = document.getElementById('viewer-3d-wrap');
        if (viewerWrap) viewerWrap.style.display = 'none';
        dispose3DViewer();
    }

    // ── Bend form UI ──

    function showAddBendForm(type, existingBend) {
        var panel = document.getElementById('planner-bend-form');
        var isEdit = !!existingBend;
        editingBendId = isEdit ? existingBend.id : null;
        var html = '';
        var title = isEdit ? 'Edit ' : 'Add ';

        // "Measure from" toggle — shown when adding a new bend and other bends exist
        var showRef = !isEdit && plannerState.bends.length > 0;
        var lastMarkPos = showRef ? getLastBendMark() : 0;
        var refSelectHtml = '';
        if (showRef) {
            refSelectHtml = '<div style="margin-bottom:8px;"><label style="font-size:0.8rem;font-weight:600;display:block;margin-bottom:2px;">Measure From</label>';
            refSelectHtml += '<select id="bf-ref" style="width:100%;padding:6px 8px;border:1px solid var(--border);border-radius:4px;font-size:0.9rem;">';
            refSelectHtml += '<option value="last">Last bend (farthest mark at ' + fmt(lastMarkPos) + '")</option>';
            refSelectHtml += '<option value="cut">Cut end of stick</option>';
            refSelectHtml += '</select></div>';
        }

        // Pipe rotation — shown when other bends exist
        var showRotation = plannerState.bends.length > 0;
        var rotSelectHtml = '';
        if (showRotation) {
            var editRot = isEdit ? (existingBend.rotation || 0) : 0;
            rotSelectHtml = '<div style="margin-bottom:8px;"><label style="font-size:0.8rem;font-weight:600;display:block;margin-bottom:2px;">Pipe Rotation</label>';
            rotSelectHtml += '<select id="bf-rotation" style="width:100%;padding:6px 8px;border:1px solid var(--border);border-radius:4px;font-size:0.9rem;">';
            rotSelectHtml += '<option value="0"' + (editRot === 0 ? ' selected' : '') + '>0\u00B0 \u2014 Same plane as last bend</option>';
            rotSelectHtml += '<option value="90"' + (editRot === 90 ? ' selected' : '') + '>90\u00B0 \u2014 Quarter turn</option>';
            rotSelectHtml += '<option value="180"' + (editRot === 180 ? ' selected' : '') + '>180\u00B0 \u2014 Opposite</option>';
            rotSelectHtml += '<option value="270"' + (editRot === 270 ? ' selected' : '') + '>270\u00B0 \u2014 Three-quarter turn</option>';
            rotSelectHtml += '</select>';
            rotSelectHtml += '<p class="field-note" style="margin:4px 0 0 0;">Rotate the pipe in the bender before this bend. 0\u00B0 = same plane as the previous bend.</p>';
            rotSelectHtml += '</div>';
        }

        if (type === 'stub90') {
            title += '90\u00B0';
            html += '<div style="font-weight:700;font-size:0.9rem;margin-bottom:8px;">' + title + '</div>';
            html += rotSelectHtml;
            html += refSelectHtml;
            html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px;">';
            html += '<div><label style="font-size:0.8rem;font-weight:600;display:block;margin-bottom:2px;">Stub Length (in)</label>';
            html += '<input type="number" id="bf-stub-length" value="' + (isEdit ? existingBend.stubLength : 12) + '" min="1" step="0.25" style="width:100%;padding:6px 8px;border:1px solid var(--border);border-radius:4px;font-size:0.9rem;"></div>';
            html += '<div><label style="font-size:0.8rem;font-weight:600;display:block;margin-bottom:2px;">' + (showRef ? 'Distance from last bend (in)' : 'Position from cut end (in)') + '</label>';
            html += '<input type="number" id="bf-position" value="' + (isEdit ? existingBend.position : '') + '" placeholder="auto from stub length" min="0" step="0.25" style="width:100%;padding:6px 8px;border:1px solid var(--border);border-radius:4px;font-size:0.9rem;"></div>';
            html += '</div>';
            html += '<p class="field-note" style="margin-bottom:10px;">Stub length is the height after the bend. Position is where the mark goes (auto-calculated if blank).</p>';
        } else if (type === 'offset') {
            title += 'Offset';
            html += '<div style="font-weight:700;font-size:0.9rem;margin-bottom:8px;">' + title + '</div>';
            html += rotSelectHtml;
            html += refSelectHtml;
            html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px;">';
            html += '<div><label style="font-size:0.8rem;font-weight:600;display:block;margin-bottom:2px;">' + (showRef ? 'Distance (in)' : 'Position (in from cut end)') + '</label>';
            html += '<input type="number" id="bf-position" value="' + (isEdit ? existingBend.position : '') + '" placeholder="e.g. 40" min="0" step="0.25" style="width:100%;padding:6px 8px;border:1px solid var(--border);border-radius:4px;font-size:0.9rem;"></div>';
            html += '<div><label style="font-size:0.8rem;font-weight:600;display:block;margin-bottom:2px;">Offset Height (in)</label>';
            html += '<input type="number" id="bf-height" value="' + (isEdit ? existingBend.height : 4) + '" min="0.5" step="0.5" style="width:100%;padding:6px 8px;border:1px solid var(--border);border-radius:4px;font-size:0.9rem;"></div>';
            html += '</div>';
            html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px;">';
            html += '<div><label style="font-size:0.8rem;font-weight:600;display:block;margin-bottom:2px;">Angle</label>';
            html += '<select id="bf-angle" style="width:100%;padding:6px 8px;border:1px solid var(--border);border-radius:4px;font-size:0.9rem;">';
            var angles = ['10','22.5','30','45','60'];
            for (var a = 0; a < angles.length; a++) {
                var sel = (isEdit && String(existingBend.angle) === angles[a]) || (!isEdit && angles[a] === '30') ? ' selected' : '';
                html += '<option value="' + angles[a] + '"' + sel + '>' + angles[a] + '\u00B0</option>';
            }
            html += '</select></div>';
            html += '<div><label style="font-size:0.8rem;font-weight:600;display:block;margin-bottom:2px;">Direction</label>';
            html += '<select id="bf-direction" style="width:100%;padding:6px 8px;border:1px solid var(--border);border-radius:4px;font-size:0.9rem;">';
            html += '<option value="up"' + (isEdit && existingBend.direction === 'up' ? ' selected' : '') + '>Up</option>';
            html += '<option value="down"' + (isEdit && existingBend.direction === 'down' ? ' selected' : '') + '>Down</option>';
            html += '</select></div>';
            html += '</div>';
            html += '<p class="field-note" style="margin-bottom:10px;">First mark at position. Second mark = position + (height \u00D7 multiplier).</p>';
        } else if (type === 'saddle3') {
            title += '3-Point Saddle';
            html += '<div style="font-weight:700;font-size:0.9rem;margin-bottom:8px;">' + title + '</div>';
            html += rotSelectHtml;
            html += refSelectHtml;
            html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px;">';
            html += '<div><label style="font-size:0.8rem;font-weight:600;display:block;margin-bottom:2px;">' + (showRef ? 'Center distance (in)' : 'Center Position (in)') + '</label>';
            html += '<input type="number" id="bf-position" value="' + (isEdit ? existingBend.position : '') + '" placeholder="e.g. 60" min="0" step="0.25" style="width:100%;padding:6px 8px;border:1px solid var(--border);border-radius:4px;font-size:0.9rem;"></div>';
            html += '<div><label style="font-size:0.8rem;font-weight:600;display:block;margin-bottom:2px;">Obstruction Height (in)</label>';
            html += '<input type="number" id="bf-height" value="' + (isEdit ? existingBend.height : 4) + '" min="0.5" step="0.5" style="width:100%;padding:6px 8px;border:1px solid var(--border);border-radius:4px;font-size:0.9rem;"></div>';
            html += '</div>';
            html += '<div style="display:grid;grid-template-columns:1fr;gap:8px;margin-bottom:10px;">';
            html += '<div><label style="font-size:0.8rem;font-weight:600;display:block;margin-bottom:2px;">Center Angle</label>';
            html += '<select id="bf-angle" style="width:100%;padding:6px 8px;border:1px solid var(--border);border-radius:4px;font-size:0.9rem;">';
            var angles = ['10','22.5','30','45','60'];
            for (var a = 0; a < angles.length; a++) {
                var sel = (isEdit && String(existingBend.centerAngle) === angles[a]) || (!isEdit && angles[a] === '30') ? ' selected' : '';
                html += '<option value="' + angles[a] + '"' + sel + '>' + angles[a] + '\u00B0</option>';
            }
            html += '</select></div>';
            html += '</div>';
            html += '<p class="field-note" style="margin-bottom:10px;">Center mark at position. Outer marks = position \u00B1 (height \u00D7 multiplier).</p>';
        } else if (type === 'kick') {
            title += 'Kick';
            html += '<div style="font-weight:700;font-size:0.9rem;margin-bottom:8px;">' + title + '</div>';
            html += rotSelectHtml;
            html += refSelectHtml;
            html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px;">';
            html += '<div><label style="font-size:0.8rem;font-weight:600;display:block;margin-bottom:2px;">' + (showRef ? 'Distance (in)' : 'Position (in from cut end)') + '</label>';
            html += '<input type="number" id="bf-position" value="' + (isEdit ? existingBend.position : '') + '" placeholder="e.g. 90" min="0" step="0.25" style="width:100%;padding:6px 8px;border:1px solid var(--border);border-radius:4px;font-size:0.9rem;"></div>';
            html += '<div><label style="font-size:0.8rem;font-weight:600;display:block;margin-bottom:2px;">Kick Angle</label>';
            html += '<select id="bf-angle" style="width:100%;padding:6px 8px;border:1px solid var(--border);border-radius:4px;font-size:0.9rem;">';
            var angles = ['10','22.5','30','45','60'];
            for (var a = 0; a < angles.length; a++) {
                var sel = (isEdit && String(existingBend.angle) === angles[a]) || (!isEdit && angles[a] === '30') ? ' selected' : '';
                html += '<option value="' + angles[a] + '"' + sel + '>' + angles[a] + '\u00B0</option>';
            }
            html += '</select></div>';
            html += '</div>';
            html += '<div style="display:grid;grid-template-columns:1fr;gap:8px;margin-bottom:10px;">';
            html += '<div><label style="font-size:0.8rem;font-weight:600;display:block;margin-bottom:2px;">Direction</label>';
            html += '<select id="bf-direction" style="width:100%;padding:6px 8px;border:1px solid var(--border);border-radius:4px;font-size:0.9rem;">';
            html += '<option value="up"' + (isEdit && existingBend.direction === 'up' ? ' selected' : '') + '>Up</option>';
            html += '<option value="down"' + (isEdit && existingBend.direction === 'down' ? ' selected' : '') + '>Down</option>';
            html += '</select></div>';
            html += '</div>';
            html += '<p class="field-note" style="margin-bottom:10px;">Single bend at the given position and angle. Used to change conduit direction.</p>';
        }

        html += '<div style="display:flex;gap:8px;">';
        html += '<button class="btn btn-sm" onclick="submitBendForm(\'' + type + '\')">' + (isEdit ? 'Update' : 'Add to Stick') + '</button>';
        html += '<button class="btn btn-outline btn-sm" onclick="hideAddBendForm()">Cancel</button>';
        html += '</div>';

        panel.innerHTML = html;
        panel.style.display = '';
        // Focus the first input
        var firstInput = panel.querySelector('input[type="number"]');
        if (firstInput) firstInput.focus();
    }

    function hideAddBendForm() {
        var panel = document.getElementById('planner-bend-form');
        if (panel) panel.style.display = 'none';
        editingBendId = null;
    }

    function submitBendForm(type) {
        var posEl = document.getElementById('bf-position');
        var position = posEl ? parseFloat(posEl.value) : 0;

        // Convert relative position to absolute if measuring from last bend
        var refEl = document.getElementById('bf-ref');
        if (refEl && refEl.value === 'last' && !isNaN(position)) {
            position += getLastBendMark();
        }

        // Read pipe rotation
        var rotEl = document.getElementById('bf-rotation');
        var rotation = rotEl ? parseInt(rotEl.value) || 0 : 0;

        if (type === 'stub90') {
            var stubLength = parseFloat(document.getElementById('bf-stub-length').value);
            if (isNaN(stubLength) || stubLength <= 0) return;
            // If position not specified, auto-calculate from stub length
            if (isNaN(position) || posEl.value === '') {
                position = stubLength - DEDUCT[plannerState.conduitSize];
                if (refEl && refEl.value === 'last') position += getLastBendMark();
                if (position < 0) position = 0;
            }
            var bend = { id: editingBendId || plannerState.nextId++, type: 'stub90', position: position, stubLength: stubLength, rotation: rotation };
        } else if (type === 'offset') {
            var height = parseFloat(document.getElementById('bf-height').value);
            var angle = parseFloat(document.getElementById('bf-angle').value);
            var direction = document.getElementById('bf-direction').value;
            if (isNaN(position) || isNaN(height) || height <= 0) return;
            var bend = { id: editingBendId || plannerState.nextId++, type: 'offset', position: position, height: height, angle: angle, direction: direction, rotation: rotation };
        } else if (type === 'saddle3') {
            var height = parseFloat(document.getElementById('bf-height').value);
            var centerAngle = parseFloat(document.getElementById('bf-angle').value);
            if (isNaN(position) || isNaN(height) || height <= 0) return;
            var bend = { id: editingBendId || plannerState.nextId++, type: 'saddle3', position: position, height: height, centerAngle: centerAngle, rotation: rotation };
        } else if (type === 'kick') {
            var angle = parseFloat(document.getElementById('bf-angle').value);
            var direction = document.getElementById('bf-direction').value;
            if (isNaN(position)) return;
            var bend = { id: editingBendId || plannerState.nextId++, type: 'kick', position: position, angle: angle, direction: direction, rotation: rotation };
        }

        if (editingBendId) {
            // Replace existing bend
            for (var i = 0; i < plannerState.bends.length; i++) {
                if (plannerState.bends[i].id === editingBendId) {
                    plannerState.bends[i] = bend;
                    break;
                }
            }
        } else {
            plannerState.bends.push(bend);
        }

        hideAddBendForm();
        recalcAllBends();
    }

    function removeBend(id) {
        plannerState.bends = plannerState.bends.filter(function(b) { return b.id !== id; });
        recalcAllBends();
    }

    function editBend(id) {
        var bend = null;
        for (var i = 0; i < plannerState.bends.length; i++) {
            if (plannerState.bends[i].id === id) { bend = plannerState.bends[i]; break; }
        }
        if (!bend) return;
        showAddBendForm(bend.type, bend);
    }

    function getLastBendMark() {
        var maxPos = 0;
        for (var i = 0; i < plannerState.bends.length; i++) {
            var b = plannerState.bends[i];
            var r;
            if (b.type === 'stub90') r = computeStubMarks(b, plannerState.conduitSize);
            else if (b.type === 'offset') r = computeOffsetMarks(b);
            else if (b.type === 'saddle3') r = computeSaddleMarks(b);
            else if (b.type === 'kick') r = computeKickMarks(b);
            if (r) {
                for (var j = 0; j < r.marks.length; j++) {
                    if (r.marks[j].pos > maxPos) maxPos = r.marks[j].pos;
                }
            }
        }
        return maxPos;
    }

    // ── Mark calculation engine ──

    function computeStubMarks(bend, conduitSize) {
        var deduct = DEDUCT[conduitSize];
        var mark = bend.stubLength - deduct;
        return {
            marks: [{ pos: mark, label: 'Stub mark (' + fmt(bend.stubLength) + '" stub)' }],
            shrink: 0,
            span: [mark, mark]
        };
    }

    function computeOffsetMarks(bend) {
        var mult = MULTIPLIERS[String(bend.angle)];
        var distance = bend.height * mult;
        var shrinkRate = SHRINK_PER_INCH[String(bend.angle)];
        var shrink = bend.height * shrinkRate;
        var mark1 = bend.position;
        var mark2 = bend.position + distance;
        return {
            marks: [
                { pos: mark1, label: 'Offset mark 1 (bend ' + bend.direction + ')' },
                { pos: mark2, label: 'Offset mark 2 (bend ' + (bend.direction === 'up' ? 'down' : 'up') + ')' }
            ],
            shrink: shrink,
            span: [mark1, mark2]
        };
    }

    function computeSaddleMarks(bend) {
        var mult = MULTIPLIERS[String(bend.centerAngle)];
        var distance = bend.height * mult;
        var shrinkRate = SHRINK_PER_INCH[String(bend.centerAngle)];
        var shrink = bend.height * shrinkRate;
        var outerAngle = parseFloat(bend.centerAngle) / 2;
        var mark1 = bend.position - distance;
        var mark2 = bend.position;
        var mark3 = bend.position + distance;
        return {
            marks: [
                { pos: mark1, label: 'Saddle outer (' + outerAngle + '\u00B0)' },
                { pos: mark2, label: 'Saddle center (' + bend.centerAngle + '\u00B0)' },
                { pos: mark3, label: 'Saddle outer (' + outerAngle + '\u00B0)' }
            ],
            shrink: shrink,
            span: [mark1, mark3]
        };
    }

    function computeKickMarks(bend) {
        return {
            marks: [{ pos: bend.position, label: 'Kick ' + bend.angle + '\u00B0 ' + bend.direction }],
            shrink: 0,
            span: [bend.position, bend.position]
        };
    }

    function validateFeasibility(allMarks, conduitSize, stickLength) {
        var warnings = [];
        var shoeLen = BENDER_SHOE[conduitSize];

        // Sort all marks by position
        var sorted = allMarks.slice().sort(function(a, b) { return a.pos - b.pos; });

        // Check gaps between adjacent marks
        for (var i = 0; i < sorted.length - 1; i++) {
            var gap = sorted[i + 1].pos - sorted[i].pos;
            if (gap > 0 && gap < shoeLen) {
                warnings.push('Marks at ' + fmt(sorted[i].pos) + '" and ' + fmt(sorted[i + 1].pos) + '" are only ' + fmt(gap) + '" apart. Your bender shoe needs at least ' + shoeLen + '" clearance for ' + CONDUIT_LABELS[conduitSize] + ' EMT.');
            }
        }

        // Check marks within stick bounds (3" buffer on each end for couplings)
        var END_BUFFER = 3;
        for (var i = 0; i < sorted.length; i++) {
            if (sorted[i].pos < 0) {
                warnings.push('Mark at ' + fmt(sorted[i].pos) + '" is before the cut end of the stick. Adjust the bend position.');
            } else if (sorted[i].pos < END_BUFFER) {
                warnings.push('Mark at ' + fmt(sorted[i].pos) + '" is only ' + fmt(sorted[i].pos) + '" from the cut end. You need at least ' + END_BUFFER + '" for a coupling.');
            }
            if (sorted[i].pos > stickLength) {
                warnings.push('Mark at ' + fmt(sorted[i].pos) + '" is past the end of your ' + stickLength + '" stick.');
            } else if (sorted[i].pos > stickLength - END_BUFFER) {
                warnings.push('Mark at ' + fmt(sorted[i].pos) + '" is only ' + fmt(stickLength - sorted[i].pos) + '" from the end of the stick. You need at least ' + END_BUFFER + '" for a coupling.');
            }
        }

        return warnings;
    }

    function recalcAllBends() {
        plannerState.conduitSize = document.getElementById('planner-conduit-size').value;
        plannerState.stickLength = parseFloat(document.getElementById('stick-length').value) || 120;

        // Sort bends by position
        plannerState.bends.sort(function(a, b) { return a.position - b.position; });

        // Compute marks for each bend
        var allMarks = [];
        var totalShrink = 0;
        var bendResults = [];

        for (var i = 0; i < plannerState.bends.length; i++) {
            var b = plannerState.bends[i];
            var result;
            if (b.type === 'stub90') result = computeStubMarks(b, plannerState.conduitSize);
            else if (b.type === 'offset') result = computeOffsetMarks(b);
            else if (b.type === 'saddle3') result = computeSaddleMarks(b);
            else if (b.type === 'kick') result = computeKickMarks(b);

            totalShrink += result.shrink;
            bendResults.push({ bend: b, result: result });
            for (var m = 0; m < result.marks.length; m++) {
                allMarks.push({ pos: result.marks[m].pos, label: result.marks[m].label, bendId: b.id });
            }
        }

        // Validate feasibility
        var warnings = validateFeasibility(allMarks, plannerState.conduitSize, plannerState.stickLength);

        // Store computed data for rendering
        plannerState._lastResults = bendResults;
        plannerState._allMarks = allMarks;
        plannerState._totalShrink = totalShrink;
        plannerState._warnings = warnings;

        renderBendList();
        renderPlannerWarnings(warnings);
        update3DView();
    }

    function renderBendList() {
        var listEl = document.getElementById('planner-bend-list');
        if (plannerState.bends.length === 0) {
            listEl.innerHTML = '<p style="color:var(--text-muted);font-size:0.85rem;padding:8px 0;">No bends added yet. Use the buttons above to build your stick.</p>';
            return;
        }

        var html = '<div style="font-weight:700;font-size:0.9rem;margin-bottom:8px;">Bends on this stick:</div>';
        var sorted = plannerState.bends.slice().sort(function(a, b) { return a.position - b.position; });

        for (var i = 0; i < sorted.length; i++) {
            var b = sorted[i];
            var desc = '';
            var rotNote = (b.rotation ? ' \u21BB' + b.rotation + '\u00B0' : '');
            if (b.type === 'stub90') {
                desc = '90\u00B0 \u2014 ' + fmt(b.stubLength) + '"' + rotNote;
            } else if (b.type === 'offset') {
                desc = 'Offset \u2014 ' + fmt(b.height) + '" ' + b.direction + ' @ ' + b.angle + '\u00B0' + rotNote;
            } else if (b.type === 'saddle3') {
                desc = '3-Pt Saddle \u2014 ' + fmt(b.height) + '" @ ' + b.centerAngle + '\u00B0' + rotNote;
            } else if (b.type === 'kick') {
                desc = 'Kick \u2014 ' + b.angle + '\u00B0 ' + b.direction + rotNote;
            }

            html += '<div style="display:flex;align-items:center;gap:8px;padding:8px 12px;margin:4px 0;background:var(--white);border:1px solid var(--border);border-radius:6px;">';
            html += '<span style="font-weight:700;color:var(--accent);min-width:20px;">' + (i + 1) + '.</span>';
            html += '<span style="flex:1;font-size:0.88rem;">' + desc + ' <span style="color:var(--text-muted);">@ ' + fmt(b.position) + '"</span></span>';
            html += '<button onclick="editBend(' + b.id + ')" style="background:none;border:none;color:var(--accent);cursor:pointer;font-size:0.82rem;font-weight:600;padding:4px 6px;">Edit</button>';
            html += '<button onclick="removeBend(' + b.id + ')" style="background:none;border:none;color:#dc2626;cursor:pointer;font-size:1.1rem;padding:4px 6px;line-height:1;">&times;</button>';
            html += '</div>';
        }

        listEl.innerHTML = html;
    }

    function renderPlannerWarnings(warnings) {
        var el = document.getElementById('planner-warnings');
        if (!warnings || warnings.length === 0) {
            el.innerHTML = '';
            return;
        }
        var html = '';
        for (var i = 0; i < warnings.length; i++) {
            html += '<div class="caution-box" style="margin:6px 0;"><strong>Warning</strong><br>' + warnings[i] + '</div>';
        }
        el.innerHTML = html;
    }

    function calcPlanner() {
        if (!plannerState._lastResults) recalcAllBends();

        var bendResults = plannerState._lastResults;
        var allMarks = plannerState._allMarks;
        var totalShrink = plannerState._totalShrink;
        var warnings = plannerState._warnings;
        var stickLen = plannerState.stickLength;
        var conduitSize = plannerState.conduitSize;

        var html = '';
        html += '<div style="font-weight:700;font-size:1.1rem;margin-bottom:14px;padding:10px 16px;background:#f5f0e6;border-left:4px solid var(--accent);border-radius:0 6px 6px 0;color:var(--text);">Stick Planner Results</div>';

        // Mark table sorted by position
        var sortedMarks = allMarks.slice().sort(function(a, b) { return a.pos - b.pos; });

        html += '<table class="breakdown-table">';
        html += '<tr><th>#</th><th>Position</th><th>Description</th></tr>';
        for (var i = 0; i < sortedMarks.length; i++) {
            html += '<tr>';
            html += '<td style="font-weight:700;color:var(--accent);">' + (i + 1) + '</td>';
            html += '<td style="font-weight:700;font-size:1.05rem;">' + fmt(sortedMarks[i].pos) + '" (' + toFraction(sortedMarks[i].pos) + ')</td>';
            html += '<td>' + sortedMarks[i].label + '</td>';
            html += '</tr>';
        }
        html += '</table>';

        // Per-bend breakdown
        for (var i = 0; i < bendResults.length; i++) {
            var br = bendResults[i];
            var b = br.bend;
            var r = br.result;
            html += '<div style="margin-top:12px;padding:10px 16px;background:var(--white);border:1px solid var(--border);border-radius:6px;">';
            var rotInfo = b.rotation ? ' <span style="color:var(--accent);">\u21BB' + b.rotation + '\u00B0 rotation</span>' : '';
            if (b.type === 'stub90') {
                html += '<div style="font-weight:700;font-size:0.92rem;">90\u00B0 \u2014 ' + fmt(b.stubLength) + '"' + rotInfo + '</div>';
                html += '<div style="font-size:0.85rem;color:var(--text-light);margin-top:4px;">Deduct: ' + DEDUCT[conduitSize] + '" \u2192 Mark at ' + fmt(r.marks[0].pos) + '"</div>';
            } else if (b.type === 'offset') {
                var dist = b.height * MULTIPLIERS[String(b.angle)];
                html += '<div style="font-weight:700;font-size:0.92rem;">Offset \u2014 ' + fmt(b.height) + '" ' + b.direction + ' @ ' + b.angle + '\u00B0' + rotInfo + '</div>';
                html += '<div style="font-size:0.85rem;color:var(--text-light);margin-top:4px;">Marks: ' + fmt(r.marks[0].pos) + '" and ' + fmt(r.marks[1].pos) + '" (distance: ' + fmt(dist) + '", shrink: ' + fmt(r.shrink) + '")</div>';
            } else if (b.type === 'saddle3') {
                var outerAngle = parseFloat(b.centerAngle) / 2;
                html += '<div style="font-weight:700;font-size:0.92rem;">3-Pt Saddle \u2014 ' + fmt(b.height) + '" @ ' + b.centerAngle + '\u00B0' + rotInfo + '</div>';
                html += '<div style="font-size:0.85rem;color:var(--text-light);margin-top:4px;">Marks: ' + fmt(r.marks[0].pos) + '", ' + fmt(r.marks[1].pos) + '", ' + fmt(r.marks[2].pos) + '" (outer ' + outerAngle + '\u00B0, shrink: ' + fmt(r.shrink) + '")</div>';
            } else if (b.type === 'kick') {
                html += '<div style="font-weight:700;font-size:0.92rem;">Kick \u2014 ' + b.angle + '\u00B0 ' + b.direction + rotInfo + '</div>';
                html += '<div style="font-size:0.85rem;color:var(--text-light);margin-top:4px;">Mark at ' + fmt(r.marks[0].pos) + '"</div>';
            }
            html += '</div>';
        }

        // Summary
        var lastMark = sortedMarks.length > 0 ? sortedMarks[sortedMarks.length - 1].pos : 0;
        var usableLength = stickLen - totalShrink;
        var remaining = usableLength - lastMark;
        html += '<div style="margin-top:16px;padding:12px 16px;background:var(--gray);border-radius:6px;">';
        html += '<table class="breakdown-table" style="margin:0;">';
        if (totalShrink > 0) {
            html += '<tr><td>Total Shrink</td><td style="font-weight:700;">' + fmt(totalShrink) + '" (' + toFraction(totalShrink) + ')</td></tr>';
            html += '<tr><td>Usable Stick Length</td><td style="font-weight:700;">' + fmt(usableLength) + '" <span style="font-weight:400;color:var(--text-light);">(' + stickLen + '" \u2212 ' + fmt(totalShrink) + '" shrink)</span></td></tr>';
        } else {
            html += '<tr><td>Stick Length</td><td>' + stickLen + '"</td></tr>';
        }
        html += '<tr><td>Farthest Mark</td><td>' + fmt(lastMark) + '"</td></tr>';
        html += '<tr><td>Conduit Remaining</td><td' + (remaining < 0 ? ' style="color:#c0392b;font-weight:700;"' : '') + '>' + fmt(remaining) + '"' + (remaining < 0 ? ' (not enough stick!)' : '') + '</td></tr>';
        html += '<tr><td>Conduit Size</td><td>' + CONDUIT_LABELS[conduitSize] + ' EMT</td></tr>';
        html += '</table>';
        html += '</div>';

        // Warnings
        if (warnings.length > 0) {
            for (var i = 0; i < warnings.length; i++) {
                html += '<div class="warning-box" style="margin-top:12px;"><strong>Warning</strong><br>' + warnings[i] + '</div>';
            }
        }

        html += '<div style="margin-top:16px;padding:12px 16px;background:var(--gray);border-radius:6px;font-size:0.88rem;">';
        html += '<strong>How to use:</strong> Measure from the cut end of your stick. Mark each position, then bend at the listed angle and direction. Account for shrink when planning your run.';
        html += '</div>';

        showResult(html);
    }

    // ══════════════════════════════════════
    //  3D VIEWER (Three.js)
    // ══════════════════════════════════════

    var viewer3d = {
        scene: null, camera: null, renderer: null, controls: null,
        pipeMesh: null, startMarker: null, animId: null, initialized: false
    };

    function init3DViewer() {
        if (viewer3d.initialized) return true;
        if (typeof THREE === 'undefined' || typeof TrackballControls === 'undefined') {
            // Three.js not loaded — show fallback
            var fallback = document.getElementById('viewer-3d-fallback');
            if (fallback) { fallback.style.display = 'flex'; }
            return false;
        }

        var canvas = document.getElementById('viewer-3d');
        var wrap = document.getElementById('viewer-3d-wrap');
        var w = wrap.clientWidth;
        var h = wrap.clientHeight;

        viewer3d.scene = new THREE.Scene();
        viewer3d.scene.background = new THREE.Color(0xffffff);

        viewer3d.camera = new THREE.PerspectiveCamera(50, w / h, 0.1, 1000);
        viewer3d.camera.position.set(0, 40, 80);

        viewer3d.renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true });
        viewer3d.renderer.setSize(w, h);
        viewer3d.renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));

        viewer3d.controls = new TrackballControls(viewer3d.camera, canvas);
        viewer3d.controls.rotateSpeed = 3.0;
        viewer3d.controls.zoomSpeed = 1.5;
        viewer3d.controls.panSpeed = 0.8;
        viewer3d.controls.staticMoving = false;
        viewer3d.controls.dynamicDampingFactor = 0.15;

        // Lighting
        var ambient = new THREE.AmbientLight(0xffffff, 0.5);
        viewer3d.scene.add(ambient);
        var dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
        dirLight.position.set(20, 40, 30);
        viewer3d.scene.add(dirLight);

        viewer3d.initialized = true;
        animate3D();
        return true;
    }

    function generatePipePath(bends, stickLength, conduitSize) {
        // Build a 3D path: start along X axis, trace arcs at each bend
        // Tracks a local coordinate frame (dir + normal) so bends after
        // a 90° don't degenerate when dir becomes parallel to global Y.
        var points = [];
        var pos = new THREE.Vector3(0, 0, 0);
        var dir = new THREE.Vector3(1, 0, 0);      // pipe forward direction
        var normal = new THREE.Vector3(0, 1, 0);   // local "up" — rotates with bends
        var radius = BEND_RADIUS[conduitSize] || 5;
        var ARC_STEPS = 16;

        // Collect all bend events sorted by position
        var markEvents = [];
        for (var i = 0; i < bends.length; i++) {
            var b = bends[i];
            var rot = b.rotation || 0;
            if (b.type === 'stub90') {
                var deduct = DEDUCT[conduitSize];
                var mark = b.stubLength - deduct;
                markEvents.push({ pos: mark, angle: 90, direction: 'up', rotation: rot });
            } else if (b.type === 'offset') {
                var mult = MULTIPLIERS[String(b.angle)];
                var dist = b.height * mult;
                markEvents.push({ pos: b.position, angle: b.angle, direction: b.direction, rotation: rot });
                markEvents.push({ pos: b.position + dist, angle: b.angle, direction: (b.direction === 'up' ? 'down' : 'up'), rotation: 0 });
            } else if (b.type === 'saddle3') {
                var mult = MULTIPLIERS[String(b.centerAngle)];
                var dist = b.height * mult;
                var outerAngle = parseFloat(b.centerAngle) / 2;
                markEvents.push({ pos: b.position - dist, angle: outerAngle, direction: 'up', rotation: rot });
                markEvents.push({ pos: b.position, angle: b.centerAngle, direction: 'down', rotation: 0 });
                markEvents.push({ pos: b.position + dist, angle: outerAngle, direction: 'up', rotation: 0 });
            } else if (b.type === 'kick') {
                markEvents.push({ pos: b.position, angle: b.angle, direction: b.direction, rotation: rot });
            }
        }
        markEvents.sort(function(a, b) { return a.pos - b.pos; });

        var currentPos = 0;
        points.push(pos.clone());

        for (var i = 0; i < markEvents.length; i++) {
            var evt = markEvents[i];
            var angleRad = evt.angle * Math.PI / 180;
            var bendSign = (evt.direction === 'up') ? 1 : -1;

            // Tangent distance: how far before/after the mark the arc starts/ends
            var tangentLen = radius * Math.tan(angleRad / 2);

            // Advance straight to the arc start (mark position minus tangent approach)
            var arcStartPos = evt.pos - tangentLen;
            var straightAdvance = arcStartPos - currentPos;
            if (straightAdvance > 0.1) {
                pos = pos.clone().add(dir.clone().multiplyScalar(straightAdvance));
                points.push(pos.clone());
                currentPos = arcStartPos;
            }

            // Apply pipe rotation (roll around pipe axis) before this bend
            if (evt.rotation) {
                var rollRad = evt.rotation * Math.PI / 180;
                var rollQ = new THREE.Quaternion().setFromAxisAngle(dir, rollRad);
                normal = normal.clone().applyQuaternion(rollQ).normalize();
            }

            // Rotation axis = side vector (perpendicular to both dir and normal)
            var rotAxis = new THREE.Vector3().crossVectors(dir, normal).normalize();

            // Arc center: displaced from pipe in the normal direction (up=toward normal, down=away)
            var toCenter = normal.clone().multiplyScalar(bendSign * radius);
            var arcCenter = pos.clone().add(toCenter);
            var radialVec = pos.clone().sub(arcCenter);

            // Generate arc points by rotating the radial vector
            for (var s = 1; s <= ARC_STEPS; s++) {
                var frac = s / ARC_STEPS;
                var stepAngle = angleRad * bendSign * frac;
                var q = new THREE.Quaternion().setFromAxisAngle(rotAxis, stepAngle);
                var rotated = radialVec.clone().applyQuaternion(q);
                var arcPt = arcCenter.clone().add(rotated);
                points.push(arcPt);
            }

            // Update position, direction, AND normal to end of arc
            pos = points[points.length - 1].clone();
            var fullQ = new THREE.Quaternion().setFromAxisAngle(rotAxis, angleRad * bendSign);
            dir = dir.clone().applyQuaternion(fullQ).normalize();
            normal = normal.clone().applyQuaternion(fullQ).normalize();
            currentPos = evt.pos + tangentLen;
        }

        // Continue straight to end of stick
        var remaining = stickLength - currentPos;
        if (remaining > 0) {
            pos = pos.clone().add(dir.clone().multiplyScalar(remaining));
            points.push(pos.clone());
        }

        return points;
    }

    function update3DView() {
        var viewerWrap = document.getElementById('viewer-3d-wrap');
        if (plannerState.bends.length === 0) {
            viewerWrap.style.display = 'none';
            return;
        }

        viewerWrap.style.display = '';
        if (!init3DViewer()) return;

        // Remove old pipe and start marker
        if (viewer3d.pipeMesh) {
            viewer3d.scene.remove(viewer3d.pipeMesh);
            viewer3d.pipeMesh.geometry.dispose();
            viewer3d.pipeMesh.material.dispose();
            viewer3d.pipeMesh = null;
        }
        if (viewer3d.startMarker) {
            viewer3d.scene.remove(viewer3d.startMarker);
            viewer3d.startMarker.traverse(function(child) {
                if (child.geometry) child.geometry.dispose();
                if (child.material) {
                    if (child.material.map) child.material.map.dispose();
                    child.material.dispose();
                }
            });
            viewer3d.startMarker = null;
        }

        var pathPoints = generatePipePath(plannerState.bends, plannerState.stickLength, plannerState.conduitSize);
        if (pathPoints.length < 2) return;

        var curve = new THREE.CatmullRomCurve3(pathPoints, false, 'catmullrom', 0.0);
        var segments = Math.max(128, pathPoints.length * 4);
        var geometry = new THREE.TubeGeometry(curve, segments, 0.5, 16, false);
        var material = new THREE.MeshStandardMaterial({ color: 0xb0b0b0, metalness: 0.7, roughness: 0.3 });
        viewer3d.pipeMesh = new THREE.Mesh(geometry, material);
        viewer3d.scene.add(viewer3d.pipeMesh);

        // Start-point label: leader line + "START" text
        var startGroup = new THREE.Group();
        var lineGeo = new THREE.CylinderGeometry(0.06, 0.06, 3, 6);
        var lineMat = new THREE.MeshBasicMaterial({ color: 0x27ae60 });
        var lineMesh = new THREE.Mesh(lineGeo, lineMat);
        lineMesh.position.set(0, -1.5, 0);
        startGroup.add(lineMesh);
        var canvas = document.createElement('canvas');
        canvas.width = 160; canvas.height = 56;
        var ctx = canvas.getContext('2d');
        ctx.fillStyle = '#27ae60';
        ctx.font = 'bold 36px sans-serif';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText('START', 80, 28);
        var texture = new THREE.CanvasTexture(canvas);
        var spriteMat = new THREE.SpriteMaterial({ map: texture });
        var sprite = new THREE.Sprite(spriteMat);
        sprite.scale.set(4, 1.4, 1);
        sprite.position.set(0, -4.2, 0);
        startGroup.add(sprite);
        startGroup.position.copy(pathPoints[0]);
        viewer3d.startMarker = startGroup;
        viewer3d.scene.add(viewer3d.startMarker);

        // Auto-frame camera
        var box = new THREE.Box3().setFromObject(viewer3d.pipeMesh);
        var center = box.getCenter(new THREE.Vector3());
        var size = box.getSize(new THREE.Vector3());
        var maxDim = Math.max(size.x, size.y, size.z);
        var dist = maxDim * 1.5;

        viewer3d.camera.position.set(center.x, center.y + dist * 0.4, center.z + dist);
        viewer3d.controls.target.copy(center);
        viewer3d.controls.update();
    }

    function reset3DCamera() {
        if (!viewer3d.initialized || !viewer3d.pipeMesh) return;
        var box = new THREE.Box3().setFromObject(viewer3d.pipeMesh);
        var center = box.getCenter(new THREE.Vector3());
        var size = box.getSize(new THREE.Vector3());
        var maxDim = Math.max(size.x, size.y, size.z);
        var dist = maxDim * 1.5;

        viewer3d.camera.position.set(center.x, center.y + dist * 0.4, center.z + dist);
        viewer3d.controls.target.copy(center);
        viewer3d.controls.update();
    }

    function animate3D() {
        viewer3d.animId = requestAnimationFrame(animate3D);
        if (viewer3d.controls) viewer3d.controls.update();
        if (viewer3d.renderer && viewer3d.scene && viewer3d.camera) {
            viewer3d.renderer.render(viewer3d.scene, viewer3d.camera);
        }
    }

    function dispose3DViewer() {
        if (viewer3d.animId) {
            cancelAnimationFrame(viewer3d.animId);
            viewer3d.animId = null;
        }
        if (viewer3d.pipeMesh) {
            viewer3d.scene.remove(viewer3d.pipeMesh);
            viewer3d.pipeMesh.geometry.dispose();
            viewer3d.pipeMesh.material.dispose();
            viewer3d.pipeMesh = null;
        }
        if (viewer3d.startMarker) {
            viewer3d.scene.remove(viewer3d.startMarker);
            viewer3d.startMarker.traverse(function(child) {
                if (child.geometry) child.geometry.dispose();
                if (child.material) {
                    if (child.material.map) child.material.map.dispose();
                    child.material.dispose();
                }
            });
            viewer3d.startMarker = null;
        }
        if (viewer3d.renderer) {
            viewer3d.renderer.dispose();
        }
        viewer3d.scene = null;
        viewer3d.camera = null;
        viewer3d.renderer = null;
        viewer3d.controls = null;
        viewer3d.initialized = false;
    }

    // Handle viewer resize
    window.addEventListener('resize', function() {
        if (!viewer3d.initialized) return;
        var wrap = document.getElementById('viewer-3d-wrap');
        if (!wrap || wrap.style.display === 'none') return;
        var w = wrap.clientWidth;
        var h = wrap.clientHeight;
        viewer3d.camera.aspect = w / h;
        viewer3d.camera.updateProjectionMatrix();
        viewer3d.renderer.setSize(w, h);
        if (viewer3d.controls) viewer3d.controls.handleResize();
    });
    </script>
    <script src="/js/app.js" defer></script>
</body>
</html>
