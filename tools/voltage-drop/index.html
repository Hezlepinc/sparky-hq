<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voltage Drop Calculator - Free NEC Compliant | Sparky HQ</title>
    <meta name="description" content="Free voltage drop calculator for electricians. Check voltage drop, find max distance, or size wire. NEC Chapter 9 Table 8 with EGC sizing per 250.122(B). Supports DC, single-phase, and three-phase.">
    <link rel="icon" type="image/png" href="/assets/logo.png">
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#1c1c1c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="stylesheet" href="/css/style.css?v=7">
    <style>
        .temp-info {
            background: var(--gray);
            border-radius: 6px;
            padding: 10px 14px;
            font-size: 0.82rem;
            color: var(--text-light);
            line-height: 1.6;
            margin-bottom: 16px;
        }
        .temp-info strong { color: var(--text); }
        .temp-info code {
            background: var(--white);
            padding: 1px 5px;
            border-radius: 3px;
            font-size: 0.8rem;
        }
        .temp-warning {
            background: #fef9ee;
            border-left: 3px solid #D4910D;
            border-radius: 0 6px 6px 0;
            padding: 10px 14px;
            font-size: 0.82rem;
            color: var(--text-light);
            line-height: 1.6;
            margin-bottom: 16px;
        }
        .temp-warning strong { color: #b87c0a; }
    </style>
</head>
<body>
    <header class="site-header">
        <div class="container">
            <a href="/" class="logo"><img src="/assets/logo.png" alt="Sparky HQ" height="50"></a>
            <nav>
                <a href="/tools/">Tools</a>
                <a href="/about.html">About</a>
            </nav>
        </div>
    </header>

    <main>
        <section class="calc-page">
            <div class="container">
                <h1>Voltage Drop Calculator <span class="nec-ref">NEC Ch.9 Table 8</span></h1>
                <p class="subtitle">Calculate voltage drop, find max distance for a wire size, or determine the right conductor for your run.</p>

                <div class="method-toggle">
                    <button class="active" onclick="setMode('check')">Check VD</button>
                    <button onclick="setMode('distance')">Max Distance</button>
                    <button onclick="setMode('wiresize')">Size Wire</button>
                </div>

                <div class="calc-form">
                    <!-- Row 1: Voltage + Circuit Type -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="voltage">System Voltage</label>
                            <select id="voltage">
                                <option value="120">120V</option>
                                <option value="208">208V</option>
                                <option value="240" selected>240V</option>
                                <option value="277">277V</option>
                                <option value="480">480V</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="circuit">Circuit Type</label>
                            <select id="circuit">
                                <option value="1ac" selected>Single Phase AC</option>
                                <option value="3ac">Three Phase AC</option>
                                <option value="dc">DC</option>
                            </select>
                        </div>
                    </div>

                    <!-- Row 2: Amps + Material -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="amps">Load (Amps)</label>
                            <input type="number" id="amps" placeholder="e.g. 20" min="0" step="0.1">
                        </div>
                        <div class="form-group">
                            <label for="material">Conductor Material</label>
                            <select id="material">
                                <option value="copper" selected>Copper</option>
                                <option value="aluminum">Aluminum</option>
                            </select>
                        </div>
                    </div>

                    <!-- Row 3: Wire Size + Distance (conditionally shown) -->
                    <div class="form-row">
                        <div class="form-group" id="wireSizeGroup">
                            <label for="wireSize">Wire Size</label>
                            <select id="wireSize">
                                <option value="14">14 AWG</option>
                                <option value="12" selected>12 AWG</option>
                                <option value="10">10 AWG</option>
                                <option value="8">8 AWG</option>
                                <option value="6">6 AWG</option>
                                <option value="4">4 AWG</option>
                                <option value="3">3 AWG</option>
                                <option value="2">2 AWG</option>
                                <option value="1">1 AWG</option>
                                <option value="1/0">1/0 AWG</option>
                                <option value="2/0">2/0 AWG</option>
                                <option value="3/0">3/0 AWG</option>
                                <option value="4/0">4/0 AWG</option>
                                <option value="250">250 kcmil</option>
                                <option value="300">300 kcmil</option>
                                <option value="350">350 kcmil</option>
                                <option value="400">400 kcmil</option>
                                <option value="500">500 kcmil</option>
                                <option value="600">600 kcmil</option>
                                <option value="750">750 kcmil</option>
                            </select>
                        </div>
                        <div class="form-group" id="distanceGroup">
                            <label for="distance">One-Way Distance (ft)</label>
                            <input type="number" id="distance" placeholder="e.g. 150" min="0" step="1">
                        </div>
                    </div>

                    <!-- Row 4: Temperature Rating + VD Limit -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="tempRating">Conductor Temperature Rating <span class="nec-ref">110.14(C)</span></label>
                            <select id="tempRating" onchange="updateTempInfo()">
                                <option value="60" selected>60°C</option>
                                <option value="75">75°C</option>
                                <option value="90">90°C</option>
                            </select>
                        </div>
                        <div class="form-group" id="vdLimitGroup">
                            <label for="vdLimit">VD Limit</label>
                            <select id="vdLimit">
                                <option value="3" selected>3% (Branch Circuit)</option>
                                <option value="5">5% (Total Feeder + Branch)</option>
                            </select>
                        </div>
                    </div>

                    <!-- Temperature Rating Info Box -->
                    <div id="tempInfo"></div>

                    <!-- Row 5: OCPD -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="ocpd">OCPD / Breaker Size <span style="font-weight:400;color:var(--text-muted);">(optional — enables EGC calc)</span></label>
                            <select id="ocpd">
                                <option value="">— Skip EGC calc —</option>
                                <option value="15">15A</option>
                                <option value="20">20A</option>
                                <option value="25">25A</option>
                                <option value="30">30A</option>
                                <option value="35">35A</option>
                                <option value="40">40A</option>
                                <option value="50">50A</option>
                                <option value="60">60A</option>
                                <option value="70">70A</option>
                                <option value="80">80A</option>
                                <option value="100">100A</option>
                                <option value="125">125A</option>
                                <option value="150">150A</option>
                                <option value="200">200A</option>
                                <option value="225">225A</option>
                                <option value="250">250A</option>
                                <option value="300">300A</option>
                                <option value="350">350A</option>
                                <option value="400">400A</option>
                                <option value="500">500A</option>
                                <option value="600">600A</option>
                                <option value="800">800A</option>
                                <option value="1000">1000A</option>
                                <option value="1200">1200A</option>
                            </select>
                        </div>
                    </div>

                    <button class="btn" onclick="calculate()">Calculate</button>
                </div>

                <div class="result" id="result"></div>
            </div>
        </section>
        <div class="disclaimer-box">
            <p>For reference only. Verify all results with the current NEC and local amendments. See <a href="/terms.html">Terms of Use</a>.</p>
        </div>
    </main>

    <footer class="site-footer">
        <div class="container">
            <p>&copy; 2026 Sparky HQ.</p>
            <p>Tools are for reference only. Always verify with the current NEC and local amendments. <a href="/terms.html" style="color:#aaa;text-decoration:underline;">Terms of Use</a></p>
        </div>
    </footer>

    <script>
    // ══════════════════════════════════════
    //  NEC DATA TABLES
    // ══════════════════════════════════════

    // NEC Ch.9 Table 8 — DC Resistance at 75°C (ohms/1000ft)
    var wireResistance = {
        copper: {
            '14':3.14,'12':1.98,'10':1.24,'8':0.778,'6':0.491,'4':0.308,'3':0.245,'2':0.194,
            '1':0.154,'1/0':0.122,'2/0':0.0967,'3/0':0.0766,'4/0':0.0608,
            '250':0.0515,'300':0.0429,'350':0.0367,'400':0.0321,'500':0.0258,'600':0.0214,'750':0.0171
        },
        aluminum: {
            '14':5.17,'12':3.25,'10':2.04,'8':1.28,'6':0.808,'4':0.508,'3':0.403,'2':0.319,
            '1':0.253,'1/0':0.201,'2/0':0.159,'3/0':0.126,'4/0':0.100,
            '250':0.0847,'300':0.0707,'350':0.0605,'400':0.0529,'500':0.0424,'600':0.0353,'750':0.0282
        }
    };

    // Wire sizes in order smallest → largest
    var wireSizes = ['14','12','10','8','6','4','3','2','1','1/0','2/0','3/0','4/0',
                     '250','300','350','400','500','600','750'];

    // Circular mil area
    var cmil = {
        '14':4110,'12':6530,'10':10380,'8':16510,'6':26240,'4':41740,'3':52620,'2':66360,
        '1':83690,'1/0':105600,'2/0':133100,'3/0':167800,'4/0':211600,
        '250':250000,'300':300000,'350':350000,'400':400000,'500':500000,'600':600000,'750':750000
    };

    // Display labels
    var wireLabel = {
        '14':'#14','12':'#12','10':'#10','8':'#8','6':'#6','4':'#4','3':'#3','2':'#2',
        '1':'#1','1/0':'1/0','2/0':'2/0','3/0':'3/0','4/0':'4/0',
        '250':'250','300':'300','350':'350','400':'400','500':'500','600':'600','750':'750'
    };

    // NEC 310.16 — Ampacity by temperature rating
    var ampacity = {
        copper: {
            '60': {'14':15,'12':20,'10':30,'8':40,'6':55,'4':70,'3':85,'2':95,
                   '1':110,'1/0':125,'2/0':145,'3/0':165,'4/0':195,
                   '250':215,'300':240,'350':260,'400':280,'500':320,'600':355,'750':400},
            '75': {'14':20,'12':25,'10':35,'8':50,'6':65,'4':85,'3':100,'2':115,
                   '1':130,'1/0':150,'2/0':175,'3/0':200,'4/0':230,
                   '250':255,'300':285,'350':310,'400':335,'500':380,'600':420,'750':475},
            '90': {'14':25,'12':30,'10':40,'8':55,'6':75,'4':95,'3':115,'2':130,
                   '1':145,'1/0':170,'2/0':195,'3/0':225,'4/0':260,
                   '250':290,'300':320,'350':350,'400':380,'500':430,'600':475,'750':535}
        },
        aluminum: {
            '60': {'12':15,'10':25,'8':30,'6':40,'4':55,'3':65,'2':75,
                   '1':85,'1/0':100,'2/0':115,'3/0':130,'4/0':150,
                   '250':170,'300':190,'350':210,'400':225,'500':260,'600':285,'750':320},
            '75': {'12':20,'10':30,'8':40,'6':50,'4':65,'3':75,'2':90,
                   '1':100,'1/0':120,'2/0':135,'3/0':155,'4/0':180,
                   '250':205,'300':230,'350':250,'400':270,'500':310,'600':340,'750':385},
            '90': {'12':25,'10':35,'8':45,'6':60,'4':75,'3':85,'2':100,
                   '1':115,'1/0':135,'2/0':150,'3/0':175,'4/0':205,
                   '250':230,'300':255,'350':280,'400':305,'500':350,'600':385,'750':435}
        }
    };

    // NEC 250.122 — Min EGC by OCPD rating
    var egcTable = [
        {max:15,  cu:'14', al:'12'},
        {max:20,  cu:'12', al:'10'},
        {max:60,  cu:'10', al:'8'},
        {max:100, cu:'8',  al:'6'},
        {max:200, cu:'6',  al:'4'},
        {max:300, cu:'4',  al:'2'},
        {max:400, cu:'3',  al:'1'},
        {max:500, cu:'2',  al:'1/0'},
        {max:600, cu:'1',  al:'2/0'},
        {max:800, cu:'1/0',al:'3/0'},
        {max:1000,cu:'2/0',al:'4/0'},
        {max:1200,cu:'3/0',al:'250'}
    ];

    // ══════════════════════════════════════
    //  TEMPERATURE INFO
    // ══════════════════════════════════════

    var tempInfoText = {
        '60': {
            type: 'info',
            html: '<strong>60°C — Standard</strong><br>' +
                  'Use when wiring with <strong>NM-B (Romex)</strong> or when terminals are rated 60°C only. ' +
                  'This is the default for most residential branch circuits using NM cable. ' +
                  'Per NEC 110.14(C), ampacity is based on the lowest temperature rating in the circuit.'
        },
        '75': {
            type: 'warning',
            html: '<strong>75°C — Verify your terminals</strong><br>' +
                  'Use when <strong>both</strong> the conductor insulation <strong>and</strong> all terminations (breaker, device, equipment) are rated 75°C or higher. ' +
                  'Common with THHN/THWN in conduit. Applies in residential or commercial — the building type does not matter. ' +
                  'Per NEC 110.14(C)(1)(a), circuits ≤100A with #14–#1 conductors: use 60°C unless all terminals are rated 75°C+.'
        },
        '90': {
            type: 'warning',
            html: '<strong>90°C — Derating calculations only</strong><br>' +
                  'The 90°C ampacity column is used <strong>only as a starting point</strong> for ampacity correction and adjustment factors ' +
                  '(conduit fill per 310.15(C)(1), ambient temperature per 310.15(B)). ' +
                  'After applying derating, the final ampacity <strong>cannot exceed</strong> the 75°C (or 60°C) column value ' +
                  'based on the terminal temperature rating. Do not use 90°C ampacity for direct conductor sizing.'
        }
    };

    function updateTempInfo() {
        var val = document.getElementById('tempRating').value;
        var info = tempInfoText[val];
        var el = document.getElementById('tempInfo');
        el.innerHTML = '<div class="' + (info.type === 'warning' ? 'temp-warning' : 'temp-info') + '">' + info.html + '</div>';
    }

    // ══════════════════════════════════════
    //  MODE MANAGEMENT
    // ══════════════════════════════════════

    var currentMode = 'check';

    function setMode(mode) {
        currentMode = mode;
        var buttons = document.querySelectorAll('.method-toggle button');
        buttons.forEach(function(b) { b.classList.remove('active'); });
        if (mode === 'check') buttons[0].classList.add('active');
        if (mode === 'distance') buttons[1].classList.add('active');
        if (mode === 'wiresize') buttons[2].classList.add('active');

        document.getElementById('wireSizeGroup').style.display = (mode === 'wiresize') ? 'none' : '';
        document.getElementById('distanceGroup').style.display = (mode === 'distance') ? 'none' : '';
        document.getElementById('vdLimitGroup').style.display = (mode === 'check') ? 'none' : '';

        document.getElementById('result').classList.remove('show');
        document.getElementById('result').innerHTML = '';
    }

    // ══════════════════════════════════════
    //  HELPERS
    // ══════════════════════════════════════

    function getMinWireForAmps(amps, material, tempRating) {
        var table = ampacity[material][tempRating];
        var startIdx = (material === 'aluminum') ? 1 : 0;
        for (var i = startIdx; i < wireSizes.length; i++) {
            var size = wireSizes[i];
            if (table[size] && table[size] >= amps) return size;
        }
        return wireSizes[wireSizes.length - 1];
    }

    function getEGC(ocpdVal, material) {
        var key = (material === 'aluminum') ? 'al' : 'cu';
        for (var i = 0; i < egcTable.length; i++) {
            if (ocpdVal <= egcTable[i].max) return egcTable[i][key];
        }
        return egcTable[egcTable.length - 1][key];
    }

    function nextSizeUp(targetCmil, material) {
        var startIdx = (material === 'aluminum') ? 1 : 0;
        for (var i = startIdx; i < wireSizes.length; i++) {
            if (cmil[wireSizes[i]] >= targetCmil) return wireSizes[i];
        }
        return wireSizes[wireSizes.length - 1];
    }

    function calcVD(R, factor, distance, amps) {
        return (factor * distance * amps * R) / 1000;
    }

    function sizeLabel(size) {
        var n = parseInt(size);
        if (!isNaN(n) && n >= 250) return size + ' kcmil';
        return wireLabel[size] + ' AWG';
    }

    function cap(s) { return s.charAt(0).toUpperCase() + s.slice(1); }

    function circuitLabel(circuit) {
        if (circuit === 'dc') return 'DC';
        if (circuit === '3ac') return '3\u03D5 AC';
        return '1\u03D5 AC';
    }

    function getFactor(circuit) {
        return (circuit === '3ac') ? 1.732 : 2;
    }

    // ══════════════════════════════════════
    //  EGC CALCULATION — NEC 250.122(B)
    // ══════════════════════════════════════

    function calcEGC(ocpdVal, material, actualWire, amps, tempRating) {
        if (!ocpdVal) return null;

        var minEGC = getEGC(ocpdVal, material);
        var minWire = getMinWireForAmps(amps, material, tempRating);

        var result = {
            minEGC: minEGC,
            minEGCLabel: sizeLabel(minEGC),
            proportional: false,
            propEGC: null,
            propEGCLabel: null,
            minWire: minWire,
            actualWire: actualWire
        };

        var minCmil = cmil[minWire];
        var actualCmil = cmil[actualWire];

        if (actualCmil > minCmil) {
            var minEGCcmil = cmil[minEGC];
            var newEGCcmil = minEGCcmil * (actualCmil / minCmil);
            var propSize = nextSizeUp(newEGCcmil, material);
            if (cmil[propSize] > cmil[minEGC]) {
                result.proportional = true;
                result.propEGC = propSize;
                result.propEGCLabel = sizeLabel(propSize);
            }
        }

        return result;
    }

    function buildEGChtml(egc, material) {
        var h = '<div style="margin-top:20px;padding-top:16px;border-top:1px solid var(--border);">';
        h += '<div style="font-weight:700;font-size:0.92rem;margin-bottom:8px;">Equipment Grounding Conductor <span class="nec-ref">250.122</span></div>';
        h += '<table class="breakdown-table">';
        h += '<tr><td>Min EGC per 250.122</td><td>' + egc.minEGCLabel + ' ' + cap(material) + '</td></tr>';
        if (egc.proportional) {
            h += '<tr><td>Proportional EGC per 250.122(B)</td><td><strong>' + egc.propEGCLabel + ' ' + cap(material) + '</strong></td></tr>';
            h += '<tr><td>Reason</td><td>Conductor upsized from ' + sizeLabel(egc.minWire) + ' to ' + sizeLabel(egc.actualWire) + ' — EGC must increase proportionally</td></tr>';
        }
        h += '</table></div>';
        return h;
    }

    // ══════════════════════════════════════
    //  AMPACITY / OCPD WARNINGS
    // ══════════════════════════════════════

    function buildWarnings(wireSize, amps, material, tempRating, ocpdVal) {
        var html = '';
        var ampTable = ampacity[material][tempRating];
        var ampRating = ampTable[wireSize];

        if (!ampRating) return '';

        // Wire undersized for load
        if (ampRating < amps) {
            html += '<div style="background:#fef2f2;border-left:4px solid #dc2626;border-radius:0 6px 6px 0;padding:12px 16px;margin-bottom:16px;font-size:0.9rem;">';
            html += '<strong style="color:#dc2626;">Conductor Undersized</strong><br>';
            html += sizeLabel(wireSize) + ' ' + cap(material) + ' is rated <strong>' + ampRating + 'A</strong> at ' + tempRating + '°C (NEC 310.16). ';
            html += 'Your load is <strong>' + amps + 'A</strong>. ';
            var minWire = getMinWireForAmps(amps, material, tempRating);
            html += 'Minimum conductor for this load: <strong>' + sizeLabel(minWire) + '</strong>.';
            html += '</div>';
        }

        // OCPD too large for wire
        if (ocpdVal && ampRating < ocpdVal) {
            // Max OCPD per 240.4(D) for small conductors
            var maxOCPD = null;
            if (wireSize === '14') maxOCPD = 15;
            if (wireSize === '12') maxOCPD = 20;
            if (wireSize === '10') maxOCPD = 30;

            if (maxOCPD && ocpdVal > maxOCPD) {
                html += '<div style="background:#fef9ee;border-left:4px solid #D4910D;border-radius:0 6px 6px 0;padding:12px 16px;margin-bottom:16px;font-size:0.9rem;">';
                html += '<strong style="color:#b87c0a;">OCPD Mismatch</strong><br>';
                html += sizeLabel(wireSize) + ' ' + cap(material) + ' max OCPD is <strong>' + maxOCPD + 'A</strong> per NEC 240.4(D). ';
                html += 'Selected breaker is <strong>' + ocpdVal + 'A</strong>.';
                html += '</div>';
            } else if (!maxOCPD && ocpdVal > ampRating) {
                html += '<div style="background:#fef9ee;border-left:4px solid #D4910D;border-radius:0 6px 6px 0;padding:12px 16px;margin-bottom:16px;font-size:0.9rem;">';
                html += '<strong style="color:#b87c0a;">OCPD Exceeds Ampacity</strong><br>';
                html += sizeLabel(wireSize) + ' ' + cap(material) + ' is rated <strong>' + ampRating + 'A</strong> at ' + tempRating + '°C. ';
                html += 'Selected breaker is <strong>' + ocpdVal + 'A</strong>. Verify overcurrent protection per NEC 240.4.';
                html += '</div>';
            }
        }

        return html;
    }

    // ══════════════════════════════════════
    //  MAIN CALCULATE
    // ══════════════════════════════════════

    function calculate() {
        var voltage = parseFloat(document.getElementById('voltage').value);
        var circuit = document.getElementById('circuit').value;
        var amps = parseFloat(document.getElementById('amps').value);
        var material = document.getElementById('material').value;
        var tempRating = document.getElementById('tempRating').value;
        var factor = getFactor(circuit);
        var ocpdVal = document.getElementById('ocpd').value ? parseInt(document.getElementById('ocpd').value) : null;

        if (!amps || amps <= 0) { alert('Enter load amps.'); return; }

        var html = '';

        // ── CHECK VD ──
        if (currentMode === 'check') {
            var wireSize = document.getElementById('wireSize').value;
            var distance = parseFloat(document.getElementById('distance').value);
            if (!distance) { alert('Enter one-way distance.'); return; }

            var R = wireResistance[material][wireSize];
            var vd = calcVD(R, factor, distance, amps);
            var vdPct = (vd / voltage) * 100;
            var deliveredV = voltage - vd;
            var pass3 = vdPct <= 3;
            var pass5 = vdPct <= 5;

            // Warnings first — above everything
            html += buildWarnings(wireSize, amps, material, tempRating, ocpdVal);

            html += '<div class="result-section">';
            html += '<div class="result-value">' + vd.toFixed(2) + ' V (' + vdPct.toFixed(2) + '%)</div>';
            html += '<div class="result-label">Voltage Drop — ' + sizeLabel(wireSize) + ' ' + cap(material) + ' @ ' + distance + ' ft</div>';
            html += '</div>';
            html += '<table class="breakdown-table">';
            html += '<tr><td>Circuit</td><td>' + voltage + 'V ' + circuitLabel(circuit) + ' — ' + amps + 'A</td></tr>';
            html += '<tr><td>Delivered Voltage</td><td>' + deliveredV.toFixed(1) + ' V</td></tr>';
            html += '<tr><td>Branch Circuit (3% max)</td><td>' + vdPct.toFixed(2) + '% — <span class="' + (pass3 ? 'result-pass' : 'result-fail') + '">' + (pass3 ? 'PASS' : 'FAIL') + '</span></td></tr>';
            html += '<tr><td>Total Circuit (5% max)</td><td>' + vdPct.toFixed(2) + '% — <span class="' + (pass5 ? 'result-pass' : 'result-fail') + '">' + (pass5 ? 'PASS' : 'FAIL') + '</span></td></tr>';

            // Show ampacity at selected temp rating
            var ampTable = ampacity[material][tempRating];
            if (ampTable[wireSize]) {
                var ampRating = ampTable[wireSize];
                var ampOk = ampRating >= amps;
                html += '<tr><td>Ampacity at ' + tempRating + '°C (310.16)</td><td>' + ampRating + 'A — <span class="' + (ampOk ? 'result-pass' : 'result-fail') + '">' + (ampOk ? 'OK' : 'UNDERSIZED') + '</span></td></tr>';
            }
            html += '</table>';

            var egc = calcEGC(ocpdVal, material, wireSize, amps, tempRating);
            if (egc) html += buildEGChtml(egc, material);

        // ── MAX DISTANCE ──
        } else if (currentMode === 'distance') {
            var wireSize = document.getElementById('wireSize').value;
            var vdLimit = parseFloat(document.getElementById('vdLimit').value) / 100;

            var R = wireResistance[material][wireSize];
            var maxDist = (vdLimit * voltage * 1000) / (factor * amps * R);

            // Warnings first
            html += buildWarnings(wireSize, amps, material, tempRating, ocpdVal);

            html += '<div class="result-section">';
            html += '<div class="result-value">' + Math.floor(maxDist) + ' ft</div>';
            html += '<div class="result-label">Max One-Way Distance at ' + (vdLimit * 100) + '% with ' + sizeLabel(wireSize) + ' ' + cap(material) + '</div>';
            html += '</div>';
            html += '<table class="breakdown-table">';
            html += '<tr><td>Circuit</td><td>' + voltage + 'V ' + circuitLabel(circuit) + ' — ' + amps + 'A</td></tr>';
            html += '<tr><td>Wire</td><td>' + sizeLabel(wireSize) + ' ' + cap(material) + '</td></tr>';
            html += '<tr><td>Resistance (Table 8)</td><td>' + R + ' \u03A9/1000ft</td></tr>';
            html += '<tr><td>VD at max distance</td><td>' + (vdLimit * 100).toFixed(0) + '% (' + (vdLimit * voltage).toFixed(1) + 'V)</td></tr>';

            var ampTable = ampacity[material][tempRating];
            if (ampTable[wireSize]) {
                var ampRating = ampTable[wireSize];
                var ampOk = ampRating >= amps;
                html += '<tr><td>Ampacity at ' + tempRating + '°C (310.16)</td><td>' + ampRating + 'A — <span class="' + (ampOk ? 'result-pass' : 'result-fail') + '">' + (ampOk ? 'OK' : 'UNDERSIZED') + '</span></td></tr>';
            }
            html += '</table>';

            var egc = calcEGC(ocpdVal, material, wireSize, amps, tempRating);
            if (egc) html += buildEGChtml(egc, material);

        // ── SIZE WIRE ──
        } else if (currentMode === 'wiresize') {
            var distance = parseFloat(document.getElementById('distance').value);
            if (!distance) { alert('Enter one-way distance.'); return; }
            var vdLimit = parseFloat(document.getElementById('vdLimit').value) / 100;

            var startIdx = (material === 'aluminum') ? 1 : 0;
            var recommended = null;
            var recVD = 0;

            // Find smallest wire that meets BOTH ampacity and VD
            var minAmpWire = getMinWireForAmps(amps, material, tempRating);
            var minAmpIdx = wireSizes.indexOf(minAmpWire);
            var searchStart = Math.max(startIdx, minAmpIdx); // Start from at least the ampacity minimum

            for (var i = startIdx; i < wireSizes.length; i++) {
                var size = wireSizes[i];
                var R = wireResistance[material][size];
                var vd = calcVD(R, factor, distance, amps);
                var vdPct = (vd / voltage) * 100;
                // Must meet VD limit AND be at least the ampacity minimum
                if (vdPct <= vdLimit * 100 && wireSizes.indexOf(size) >= minAmpIdx) {
                    recommended = size;
                    recVD = vdPct;
                    break;
                }
            }

            if (!recommended) {
                html += '<div class="result-section">';
                html += '<div class="result-value result-fail">No Standard Size</div>';
                html += '<div class="result-label">No single conductor meets ' + (vdLimit * 100) + '% VD limit at ' + distance + ' ft and ' + amps + 'A. Consider parallel runs.</div>';
                html += '</div>';
            } else {
                var recIdx = wireSizes.indexOf(recommended);
                var upsized = recIdx > minAmpIdx;
                var ampTable = ampacity[material][tempRating];

                html += '<div class="result-section">';
                html += '<div class="result-value">' + sizeLabel(recommended) + ' ' + cap(material) + '</div>';
                html += '<div class="result-label">Recommended conductor for ' + (vdLimit * 100) + '% VD limit</div>';
                html += '</div>';
                html += '<table class="breakdown-table">';
                html += '<tr><td>Circuit</td><td>' + voltage + 'V ' + circuitLabel(circuit) + ' — ' + amps + 'A @ ' + distance + ' ft</td></tr>';
                html += '<tr><td>VD at ' + sizeLabel(recommended) + '</td><td>' + recVD.toFixed(2) + '% (' + (recVD / 100 * voltage).toFixed(1) + 'V drop)</td></tr>';
                html += '<tr><td>Delivered Voltage</td><td>' + (voltage - (recVD / 100 * voltage)).toFixed(1) + 'V</td></tr>';
                html += '<tr><td>Ampacity at ' + tempRating + '°C (310.16)</td><td>' + sizeLabel(minAmpWire) + ' (' + ampTable[minAmpWire] + 'A)</td></tr>';
                if (upsized) {
                    html += '<tr><td>Upsized for VD?</td><td><span class="result-fail">Yes</span> — ' + sizeLabel(minAmpWire) + ' \u2192 ' + sizeLabel(recommended) + '</td></tr>';
                } else {
                    html += '<tr><td>Upsized for VD?</td><td><span class="result-pass">No</span> — ampacity minimum meets VD requirement</td></tr>';
                }
                html += '</table>';

                var egc = calcEGC(ocpdVal, material, recommended, amps, tempRating);
                if (egc) html += buildEGChtml(egc, material);
            }
        }

        var resultEl = document.getElementById('result');
        resultEl.innerHTML = html;
        resultEl.classList.add('show');
    }

    // ── Initialize ──
    setMode('check');
    updateTempInfo();
    </script>
    <script src="/js/app.js" defer></script>
</body>
</html>
